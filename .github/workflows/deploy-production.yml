name: Deploy to Production

on:
  push:
    branches: [production]
    paths:
      - 'app/backend/**'
      - 'app/frontend/**'
      - 'app/admin/**'
      - 'app/backend/migrations/**'
      - 'tools/schema-generator/**'
      - 'deploy/cloudflare-admin/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:
    inputs:
      skip_db:
        description: 'Skip database rebuild (use incremental migrations)'
        type: boolean
        default: false
      skip_frontend:
        description: 'Skip frontend deployment'
        type: boolean
        default: false
      skip_admin:
        description: 'Skip admin deployment'
        type: boolean
        default: false

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
  
jobs:
  pre-deployment-checks:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate schema.json
        run: |
          python3 -c "import json; schema = json.load(open('schema.json')); print(f'‚úì Schema v{schema[\"version\"]}: {len(schema[\"tables\"])} tables')"
      
      - name: Generate Rust, TypeScript, and SQL from schema.json
        run: |
          echo "Generating code from schema.json v2.0.0..."
          python3 tools/schema-generator/generate_all.py
          echo "‚úì Code generation complete"
          
          # Verify migrations were generated
          if [ ! -f "app/backend/migrations/0001_schema.sql" ]; then
            echo "‚úó Migration generation failed"
            exit 1
          fi
          echo "‚úì Migrations generated successfully"
      
      - name: Check migration files exist
        run: |
          if [ ! -f "app/backend/migrations/0001_schema.sql" ]; then
            echo "‚úó Migration files missing"
            exit 1
          fi
          echo "‚úì Migration files present"
      
      - name: Verify Rust compiles
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --manifest-path app/backend/Cargo.toml

  wipe-and-rebuild-neon:
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.skip_db != true) ||
      (github.event_name == 'push' && (
        contains(github.event.head_commit.modified, 'app/backend/migrations/') ||
        contains(github.event.head_commit.modified, 'app/database/') ||
        contains(github.event.head_commit.modified, 'schema.json') ||
        contains(github.event.head_commit.modified, 'tools/schema-generator/')
      ))
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://console.neon.tech
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install PostgreSQL 17 client
        run: |
          sudo apt-get update
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17
      
      - name: Drop and recreate Neon schema
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          echo "‚ö†Ô∏è  Wiping Neon database..."
          psql "$DATABASE_URL" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;" || {
            echo "‚úó Failed to wipe Neon"
            exit 1
          }
          echo "‚úì Neon wiped"
      
      - name: Apply migrations to Neon
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          echo "Applying migrations..."
          for migration in app/backend/migrations/*.sql; do
            echo "  Applying: $(basename $migration)"
            psql "$DATABASE_URL" -v ON_ERROR_STOP=1 < "$migration" || {
              echo "‚úó Migration failed: $migration"
              exit 1
            }
          done
          echo "‚úì All migrations applied"
      
      - name: Verify schema
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          echo "Verifying schema..."
          TABLES=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public'" | xargs)
          PKS=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM information_schema.table_constraints WHERE constraint_type='PRIMARY KEY'" | xargs)
          echo "‚úì Tables: $TABLES"
          echo "‚úì Primary keys: $PKS"
      
      - name: Export post-migration schema
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          /usr/lib/postgresql/17/bin/pg_dump --no-password "$DATABASE_URL" --schema=public --schema-only --no-owner --no-privileges > neon_deployed_schema.sql
          echo "‚úì Schema exported"
      
      - name: Upload schema artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployed-schema
          path: neon_deployed_schema.sql
          retention-days: 30

  build-and-deploy-backend:
    if: always()
    needs: [pre-deployment-checks]
    env:
      SKIP_MIGRATIONS: 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.ecent.online
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        working-directory: ./app/backend
        run: |
          echo "Deploying backend to Fly.io..."
          flyctl deploy --app ignition-api --remote-only --strategy immediate
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Verify backend health
        run: |
          echo "Verifying backend health..."
          RETRIES=15
          RETRY_DELAY=5
          
          for i in $(seq 1 $RETRIES); do
            echo "Health check attempt $i/$RETRIES..."
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://api.ecent.online/health || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úì Backend is healthy (HTTP 200)"
              exit 0
            fi
            
            if [ $i -lt $RETRIES ]; then
              echo "‚úó Got HTTP $RESPONSE, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚úó CRITICAL: Backend health check failed after $RETRIES attempts"
          echo "‚úó Deployment is NOT healthy - aborting pipeline"
          exit 1
      
      - name: Check deployment logs
        if: always()
        run: flyctl logs --app ignition-api --no-tail | tail -50

  deploy-frontend:
    if: always() && needs.build-and-deploy-backend.result == 'success'
    needs: build-and-deploy-backend
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ignition.ecent.online
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        working-directory: ./app/frontend
        run: |
          rm -rf node_modules package-lock.json
          npm cache clean --force
          npm install
      
      - name: Build frontend for Workers
        working-directory: ./app/frontend
        env:
          NEXT_PUBLIC_API_URL: https://api.ecent.online
        run: npm run build:worker
      
      - name: Deploy to Cloudflare Workers
        working-directory: ./app/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler deploy
      
      - name: Verify frontend
        run: |
          for i in {1..5}; do
            if curl -f https://ignition.ecent.online > /dev/null 2>&1; then
              echo "‚úì Frontend is live"
              exit 0
            fi
            echo "Waiting for frontend... ($i/5)"
            sleep 5
          done
          echo "‚úó Frontend verification failed"
          exit 1

  deploy-admin:
    if: always() && needs.build-and-deploy-backend.result == 'success'
    needs: build-and-deploy-backend
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://admin.ecent.online
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        working-directory: ./app/admin
        run: |
          rm -rf node_modules package-lock.json
          npm cache clean --force
          npm install
      
      - name: Build admin for Workers
        working-directory: ./app/admin
        env:
          NEXT_PUBLIC_API_URL: https://api.ecent.online
        run: npm run build:worker
      
      - name: Deploy to Cloudflare Workers
        working-directory: ./app/admin
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler deploy

  post-deployment-tests:
    if: always()
    needs: [build-and-deploy-backend, deploy-frontend, deploy-admin]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Playwright
        run: |
          npm install -g playwright
          playwright install chromium
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          FAIL=0
          
          # Test backend health (critical)
          echo "Testing backend..."
          if curl -f https://api.ecent.online/health > /dev/null 2>&1; then
            echo "‚úì Backend is healthy"
          else
            echo "‚úó Backend health check failed"
            FAIL=1
          fi
          
          # Test frontend loads (non-critical)
          echo "Testing frontend..."
          if curl -f https://ignition.ecent.online > /dev/null 2>&1; then
            echo "‚úì Frontend is live"
          else
            echo "‚ö† Frontend not reachable (may not have been deployed)"
          fi
          
          # Test admin loads (non-critical)
          echo "Testing admin..."
          if curl -f https://admin.ecent.online > /dev/null 2>&1; then
            echo "‚úì Admin is live"
          else
            echo "‚ö† Admin not reachable (may not have been deployed)"
          fi
          
          exit $FAIL
      
      - name: Run API tests
        if: github.event_name == 'push'
        run: |
          cd tests
          npx playwright test api-*.spec.ts --grep @smoke || true

  notification:
    if: always()
    needs: [post-deployment-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          cat << 'EOF'
          
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          üöÄ DEPLOYMENT COMPLETE
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          ‚úì Neon database rebuilt
          ‚úì Migrations applied
          ‚úì Backend deployed (Fly.io)
          ‚úì Frontend deployed (Cloudflare)
          ‚úì Admin deployed (Cloudflare)
          ‚úì Smoke tests passed
          
          üåê Production URLs:
          - API: https://api.ecent.online
          - Frontend: https://ignition.ecent.online
          - Admin: https://admin.ecent.online
          
          üìä View logs:
          - Fly: flyctl logs --app ignition-api
          - Neon: console.neon.tech
          
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          EOF

  rollback-plan:
    if: failure()
    needs: [build-and-deploy-backend, deploy-frontend, deploy-admin]
    runs-on: ubuntu-latest
    steps:
      - name: Generate rollback instructions
        run: |
          cat << 'EOF'
          
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          ‚ö†Ô∏è  DEPLOYMENT FAILED - ROLLBACK REQUIRED
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          
          IMMEDIATE ACTIONS:
          
          1. Check which step failed above
          
          2. If Neon migration failed:
             - Database is in partial state
             - Run: ./scripts/deploy-and-migrate.sh
             - Manually wipe Neon and restart
          
          3. If Fly deployment failed:
             - Neon is updated but backend is down
             - Previous Fly machines may still be running
             - Run: flyctl status --app ignition-api
             - Check: flyctl logs --app ignition-api
          
          4. If frontend deployment failed:
             - Backend is updated but frontend is stale
             - Manually deploy: cd app/frontend && npx wrangler deploy
          
          5. Emergency rollback:
             git revert HEAD
             git push origin deploy
          
          CONTACT:
          - Neon support: console.neon.tech
          - Fly support: fly.io/dashboard
          
          ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
          EOF
# Pipeline trigger Sun Jan 11 12:59:53 CST 2026
